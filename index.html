<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Retirex â€“ Asesor Inteligente de Retiro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-68HDQMVBVX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-68HDQMVBVX');
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --magenta:#a0005a;
      --blue:#004b9a;
      --bg:#e5e5e5;
      --chat-bg:#f2f2f7;
      --bubble-user:#d40077;
      --bubble-ai:#ffffff;
      --radius:16px;
    }
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
    }
    .chat-container{width:100%;max-width:480px;height:100vh;background:var(--chat-bg);display:flex;flex-direction:column;padding-bottom:80px}
    .header{background:linear-gradient(135deg,var(--magenta),var(--blue));padding:14px;color:#fff;display:flex;gap:12px;font-weight:600;box-shadow: 0 2px 5px rgba(0,0,0,0.1)}
    .avatar{width:38px;height:38px;background:#fff;color:var(--magenta);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
    .messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px}
    .msg{max-width:85%;padding:12px 16px;border-radius:var(--radius);font-size:14px;line-height:1.45;animation: fadeIn 0.3s ease;word-wrap: break-word;}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .ai{background:#fff;align-self:flex-start;border:1px solid rgba(0,0,0,.06);box-shadow:0 3px 10px rgba(0,0,0,.08)}
    .user{background:var(--bubble-user);color:#fff;align-self:flex-end}
    
    /* Inicio Visual con Tarjetas */
    .visual-options { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; width: 100%; }
    .card-option { background: #fff; border: 1px solid #e0e0e0; border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .card-option:hover { border-color: var(--magenta); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .card-option span { font-size: 24px; display: block; margin-bottom: 8px; }
    .card-option strong { display: block; color: var(--blue); font-size: 15px; margin-bottom: 4px; }
    .card-option p { margin: 0; font-size: 12px; color: #666; line-height: 1.3; }

    .input-area{position:fixed;bottom:0;width:100%;max-width:480px;background:#fff;padding:12px;display:flex;gap:10px;border-top:1px solid #ccc;box-sizing: border-box;}
    .input-area input{flex:1;padding:12px;border-radius:var(--radius);border:1px solid #ddd;outline:none;font-size:14px}
    .input-area button{background:var(--magenta);color:#fff;border:none;border-radius:var(--radius);padding:0 20px;font-weight:600;cursor:pointer}
    
    .option-button{
  width:100%;
  padding:14px;          /* â¬…ï¸ mÃ¡s cÃ³modo al tacto */
  background:#fff;
  border-radius:14px;
  border:1px solid #dcdcdc;
  margin-top:10px;
  text-align:left;
  font-weight:600;
  font-size:15px;        /* â¬…ï¸ tÃ­tulo mÃ¡s legible */
  cursor:pointer;
}

.info-block{
  display:none;
  background:#f8f9fa;
  border:1px solid #e5e5e5;
  border-radius:14px;
  padding:16px;
  font-size:15px;          /* â¬…ï¸ mÃ¡s grande */
  line-height:1.6;         /* â¬…ï¸ mÃ¡s aire */
  margin-top:8px;
}

    .analysis-card { background: #fff; border-left: 5px solid var(--magenta); padding: 15px; border-radius: 12px; margin: 10px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .chart-wrapper{background:#fff;padding:14px;border-radius:16px;border:1px solid #e5e5e5;margin-top: 10px;}
    .cta-whatsapp{margin-top:18px;padding:16px;background:#fff;border-radius:14px;border:1px solid #e3e3e3;text-align: center;}
    .whatsapp-btn{background:#25D366;color:#fff;padding:12px 20px;border-radius:10px;font-weight:600;text-decoration:none;display:inline-block}
    .privacidad{font-size:11px;color:#6b6b6b;margin-top:8px}
  </style>
</head>

<body>
<div class="chat-container">
  <div class="header">
    <div class="avatar">R</div>
    Retirex â€“ Asesor Inteligente
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input id="userInput" placeholder="EscribÃ­ tu consulta..." autocomplete="off" />
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
let flow={step:0};

/* ================= TRACKING GA4 ================= */
function trackStep(name, val = null) {
  console.log(`[TRACKING]: ${name} | ${val}`);
  gtag('event', name, { 'event_category': 'Simulador_Retirex', 'value': val });
}

function addMessage(text, who="ai"){
  const d=document.createElement("div");
  d.className="msg "+who;
  d.innerHTML=text;
  document.getElementById("messages").appendChild(d);
  d.scrollIntoView({behavior:"smooth"});
}

function toggleBlock(id){
  const e=document.getElementById(id);
  if(e) e.style.display=e.style.display==="block"?"none":"block";
}

/* ================= ANALISIS DINÃMICO (IA LOCAL) ================= */
function generateAnalysis(edad, retiro, aporte) {
  const aÃ±osAhorro = retiro - edad;
  if (aÃ±osAhorro >= 25) {
    return `<strong>AnÃ¡lisis Retirex: El poder del tiempo</strong><br>TenÃ©s una ventaja estratÃ©gica: <strong>${aÃ±osAhorro} aÃ±os</strong> de capitalizaciÃ³n. A este ritmo, el interÃ©s compuesto harÃ¡ el mayor esfuerzo por vos. Es un plan sÃ³lido y de alta eficiencia.`;
  }
  if (aÃ±osAhorro < 20 && aporte >= 80000) {
    return `<strong>AnÃ¡lisis Retirex: Intensidad de capital</strong><br>Tu capacidad de aporte actual compensa el factor tiempo. EstÃ¡s construyendo un blindaje financiero rÃ¡pido y robusto para tu etapa de retiro.`;
  }
  if (aÃ±osAhorro < 15) {
    return `<strong>AnÃ¡lisis Retirex: OptimizaciÃ³n estratÃ©gica</strong><br>Con ${aÃ±osAhorro} aÃ±os restantes, el enfoque es la constancia. Tu plan es un gran primer paso; recordÃ¡ que siempre podrÃ¡s realizar aportes extraordinarios para potenciar el capital final.`;
  }
  return `<strong>AnÃ¡lisis Retirex: Plan Equilibrado</strong><br>Tu simulaciÃ³n muestra una relaciÃ³n saludable entre edad y esfuerzo de ahorro. Mantener este aporte mensual es lo que garantizarÃ¡ tu seguridad futura.`;
}

/* ================= BIENVENIDA VISUAL ================= */
function sendWelcome(){
  addMessage(`Hola ğŸ‘‹ soy <strong>Retirex</strong>, tu asesor digital de PrevenciÃ³n Retiro.<br><br>Â¿En quÃ© etapa de tu futuro te gustarÃ­a enfocarte hoy?`);
  addMessage(`
    <div class="visual-options">
      <div class="card-option" onclick="startSimulation('Independencia')">
        <span>ğŸï¸</span>
        <strong>Independencia Retiro</strong>
        <p>ProyectÃ¡ un futuro con libertad financiera.</p>
      </div>
      <div class="card-option" onclick="startSimulation('ProtecciÃ³n')">
        <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</span>
        <strong>ProtecciÃ³n Familiar</strong>
        <p>AsegurÃ¡ el futuro de los que mÃ¡s querÃ©s.</p>
      </div>
      <div class="card-option" onclick="showFAQ()">
        <span>ğŸ’¬</span>
        <strong>Dudas frecuentes</strong>
        <p>Seguridad, rescates y garantÃ­as del plan.</p>
      </div>
    </div>
  `);
}

function showFAQ(){
  addMessage(`
    <strong>Dudas frecuentes</strong><br><br>

    <button class="option-button" onclick="toggleBlock('faq1')">
      ğŸ§  Â¿QuÃ© es un plan de retiro y para quÃ© sirve?
    </button>
    <div id="faq1" class="info-block">
      Un plan de retiro es un ahorro de largo plazo regulado por la
      <strong>Superintendencia de Seguros de la NaciÃ³n</strong>.<br><br>

      Su objetivo es complementar tu jubilaciÃ³n futura con un capital propio.<br><br>

      Funciona de forma simple:
      <ul>
        <li>AportÃ¡s un monto mensual que elegÃ­s</li>
        <li>Ese dinero se capitaliza con el tiempo</li>
        <li>Al retirarte, contÃ¡s con un fondo acumulado</li>
      </ul>

      No reemplaza la jubilaciÃ³n estatal.
      La refuerza.<br><br>

      ğŸ‘‰ La clave no es cuÃ¡nto ponÃ©s hoy,
      sino cuÃ¡nto tiempo dejÃ¡s trabajar al plan.
    </div>

    <button class="option-button" onclick="toggleBlock('faq2')">
      ğŸ›¡ï¸ Â¿QuÃ© tan seguro es este plan?
    </button>
    <div id="faq2" class="info-block">
      Este plan es un producto de <strong>PrevenciÃ³n Retiro</strong>,
      compaÃ±Ã­a especializada en seguros de retiro,
      parte del <strong>Grupo Sancor Seguros</strong>.<br><br>

      EstÃ¡ regulado por la
      <strong>Superintendencia de Seguros de la NaciÃ³n</strong>
      y funciona bajo capitalizaciÃ³n individual.<br><br>

      âœ”ï¸ Tu ahorro se registra a tu nombre<br>
      âœ”ï¸ No se mezcla con otros fondos<br>
      âœ”ï¸ EstÃ¡ sujeto a controles de solvencia estrictos<br><br>

      AdemÃ¡s, cuenta con un
      <strong>rendimiento tÃ©cnico garantizado del 4 % anual en pesos</strong>.<br><br>

      ğŸ‘‰ La simulaciÃ³n muestra escenarios posibles.
      La garantÃ­a protege el capital que aportÃ¡s.
    </div>

    <button class="option-button" onclick="toggleBlock('faq3')">
      ğŸ”„ Â¿QuÃ© pasa si mi situaciÃ³n cambia?
    </button>
    <div id="faq3" class="info-block">
      Cambiar de situaciÃ³n es lo normal.
      Por eso este plan es flexible.<br><br>

      A lo largo del tiempo podÃ©s:
      <ul>
        <li>Subir o bajar el aporte</li>
        <li>Pausar pagos sin perder lo acumulado</li>
        <li>Hacer aportes extraordinarios</li>
        <li>Evaluar rescates segÃºn la etapa del plan</li>
      </ul>

      No es un compromiso rÃ­gido.
      Es un ahorro que se adapta a tu vida.<br><br>

      ğŸ‘‰ El objetivo no es perfecciÃ³n,
      sino constancia en el tiempo.
    </div>

    <button class="option-button" onclick="toggleBlock('faq4')">
      ğŸ’° Â¿Se puede retirar el dinero antes?
    </button>
    <div id="faq4" class="info-block">
      SÃ­, existen rescates anticipados,
      pero el plan estÃ¡ pensado para el largo plazo.<br><br>

      Los rescates pueden tener ajustes segÃºn:
      <ul>
        <li>AntigÃ¼edad del plan</li>
        <li>Momento del rescate</li>
        <li>Condiciones de la pÃ³liza</li>
      </ul>

      No es una cuenta corriente.
      Es un ahorro con objetivo.<br><br>

      ğŸ‘‰ Siempre conviene analizar cada caso
      antes de decidir.
    </div>

    <button class="option-button" onclick="toggleBlock('faq5')">
      ğŸ§¾ Â¿En quÃ© se diferencia de una AFJP?
    </button>
    <div id="faq5" class="info-block">
      Las AFJP fueron un sistema previsional obligatorio
      que existiÃ³ en Argentina hasta 2008.<br><br>

      Un seguro de retiro es distinto:
      <ul>
        <li>Es voluntario</li>
        <li>No reemplaza la jubilaciÃ³n estatal</li>
        <li>Es un ahorro complementario y personal</li>
      </ul>

      Ambos usan capitalizaciÃ³n individual,
      pero este plan lo contratÃ¡s
      <strong>por decisiÃ³n propia</strong>.<br><br>

      ğŸ‘‰ Hoy no se trata de elegir un sistema,
      sino de construir respaldo propio.
    </div>

    <br>
    <button class="option-button" onclick="startSimulation()">
      ğŸ§® Simular mi plan
    </button>
  `);
}


function startSimulation(meta){
  flow={step:1, meta: meta};
  trackStep('simulacion_inicio', meta);
  addMessage(`Excelente elecciÃ³n: <strong>${meta}</strong>. Vamos a calcularlo.<br><br>Â¿CuÃ¡l es tu sexo? (M/F)`);
}

async function sendMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  addMessage(text, "user");
  input.value = "";
  if (flow.step > 0) { handleFlow(text); return; }
  addMessage("Dame un segundo...", "ai");
  try {
    const r = await fetch("https://retirex-api-v1-571092083944.us-east1.run.app/ia", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        messages: [
          { role: "system", content: "Asesor Retirex" }, 
          { role: "user", content: text }
        ] 
      })
    });
    const data = await r.json();
    addMessage(data?.reply || "Podemos iniciar una simulaciÃ³n si querÃ©s ğŸ˜Š");
  } catch (e) { 
    addMessage("Por ahora podemos seguir con la simulaciÃ³n."); 
  }
}

function handleFlow(msg){
  if (flow.step === 1) {
    const s = msg.trim().toUpperCase();
    if (s !== "M" && s !== "F") { addMessage("IngresÃ¡ **M** o **F**"); return; }
    flow.sexo = s; flow.step = 2;
    trackStep('paso_sexo', s);
    addMessage("ğŸ‘ Â¿CuÃ¡l es tu edad actual?");
    return;
  }
  if (flow.step === 2) {
    const e = Number(msg);
    if (isNaN(e) || e < 18 || e > 70) { addMessage("IngresÃ¡ una edad entre 18 y 70"); return; }
    flow.edad = e; flow.step = 3;
    trackStep('paso_edad', e);
    addMessage("Â¿A quÃ© edad te gustarÃ­a retirarte?");
    return;
  }
  if (flow.step === 3) {
    const r = Number(msg);
    if (isNaN(r) || r < flow.edad + 5 || r > 85) { addMessage(`IngresÃ¡ una edad superior a ${flow.edad+5}`); return; }
    flow.retiro = r; flow.step = 4;
    trackStep('paso_retiro', r);
    addMessage("Perfecto. Â¿CuÃ¡nto querÃ©s aportar por mes? (MÃ­nimo $40.000)");
    return;
  }
 if (flow.step === 4) {
  const a = Number(msg);
  // Cambiamos el lÃ­mite de 30000 a 40000 para que coincida con la compaÃ±Ã­a
  if (isNaN(a) || a < 40000) { 
    addMessage("La compaÃ±Ã­a ha actualizado el aporte mÃ­nimo a $40.000. Por favor, ingresa un monto igual o superior."); 
    return; 
  } 
  flow.aporte = a; 
  flow.step = 0;
  trackStep('paso_aporte', a);
  runSimulation();
}
}
/* ================= SIMULACIÃ“N CON ENTREGA PROGRESIVA RECARGADA ================= */
async function runSimulation() {
  const { sexo, edad, retiro, aporte } = flow;
  
  // 1. Feedback inmediato
  addMessage("Calculando tu simulaciÃ³n... â³");

  // 2. Mostrar AnÃ¡lisis Retirex de inmediato (Sin delay, para que sea lo primero)
  const analysisHTML = generateAnalysis(edad, retiro, aporte);
  addMessage(`<div class="analysis-card">${analysisHTML}</div>`);

  try {
    // 3. Llamada a Google Cloud (La autopista)
    const r = await fetch("https://retirex-api-v1-571092083944.us-east1.run.app/cotizar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sexo, edad_actual: edad, edad_retiro: retiro, aporte_mensual: aporte })
    });
    
    const data = await r.json();
    const oficial = data.oficial.capital;
    const realista = data.realista.capital;

    // 4. Resultados NumÃ©ricos (Aparecen ni bien llega el dato)
    addMessage(`
      <strong>Resultados listos ğŸ‰</strong><br><br>
      <strong>Escenario oficial:</strong><br>$${oficial.toLocaleString("es-AR")}<br><br>
      <strong>Escenario realista:</strong><br>$${realista.toLocaleString("es-AR")}
    `);
    gtag('event', 'cotizacion_completada', { event_category: 'Retirex', event_label: 'SimulaciÃ³n finalizada' });

    // 5. ExplicaciÃ³n y GrÃ¡fico con un pequeÃ±o delay para que el usuario pueda respirar
    setTimeout(() => {
      addMessage(`
        ğŸ” <strong>Por quÃ© la diferencia es tan grande</strong><br><br>
        La diferencia no estÃ¡ en cuÃ¡nto tiempo pasa, sino en cÃ³mo ese tiempo amplifica distintos supuestos de crecimiento.<br><br>
        ğŸ‘‰ Es una forma de entender cÃ³mo el largo plazo potencia los resultados.
      `);
    }, 1000);

   // ETAPA 6: GrÃ¡fico y GuÃ­a Detallada (Recuperada)
      const chartId = "chart" + Date.now();
      addMessage(`<div class="chart-wrapper"><strong>ComparaciÃ³n grÃ¡fica</strong><br><br><canvas id="${chartId}" height="160"></canvas></div>`);
      
      new Chart(document.getElementById(chartId), {
        type: "bar",
        data: { labels: ["Oficial", "Realista"], datasets: [{ data: [oficial, realista], backgroundColor: ["#a0005a", "#004b9a"], borderRadius: 10 }] },
        options: { plugins: { legend: { display: false } } }
      });
addMessage(`<div style="font-size:12px;color:#666;margin-top:10px;"><strong>Importante:</strong> SimulaciÃ³n orientativa. No constituye garantÃ­a de rendimiento futuro ni promesa de resultado exacto.</div>`);
      addMessage(`
        <strong>Antes de seguir, una breve guÃ­a ğŸ‘‡</strong>
        
        <button class="option-button" onclick="toggleBlock('post1')">ğŸ§  CÃ³mo leer estos resultados</button>
        <div id="post1" class="info-block">
          Esta simulaciÃ³n muestra <strong>dos escenarios distintos</strong> porque un ahorro de largo plazo no se puede analizar con una sola cifra.<br><br>
          ğŸ”¹ <strong>Escenario Oficial:</strong> Es una simulaciÃ³n estimada por la compaÃ±Ã­a, construida bajo criterios conservadores.<br><br>
          ğŸ”¹ <strong>Escenario Realista:</strong> Refleja un crecimiento mÃ¡s alineado con la lÃ³gica del largo plazo en Argentina.
        </div>
        
        <button class="option-button" onclick="toggleBlock('post2')">ğŸ›¡ï¸ QuÃ© tan seguro es este plan</button>
        <div id="post2" class="info-block">
          Producto de <strong>PrevenciÃ³n Retiro (Grupo Sancor Seguros)</strong>. Regulado por la SSN. CapitalizaciÃ³n individual: tu ahorro se registra a tu nombre y cuenta con un <strong>rendimiento tÃ©cnico garantizado del 4% anual en pesos</strong>.
        </div>
        
        <button class="option-button" onclick="toggleBlock('post3')">ğŸ”„ QuÃ© pasa si mi situaciÃ³n cambia</button>
        <div id="post3" class="info-block">
          Este plan no es rÃ­gido. PodÃ©s subir o bajar el aporte, pausarlo si lo necesitÃ¡s o hacer aportes extraordinarios. Se adapta a tu realidad.
        </div>
      `);

      // ETAPA 7: WhatsApp final
      const wsp = encodeURIComponent(`Hola, quiero avanzar con mi plan. Datos: ${edad} aÃ±os, aporte $${aporte}. Escenario realista: $${realista.toLocaleString("es-AR")}`);
      addMessage(`
        <div class="cta-whatsapp">
          <a class="whatsapp-btn" href="https://wa.me/5492804866612?text=${wsp}" target="_blank">ğŸ“² Hablar con un asesor</a>
          <p class="privacidad">Sin spam. Solo asesoramiento real.</p>
        </div>
      `);

  } catch (e) { 
    addMessage("Error de conexiÃ³n. Por favor reintentÃ¡."); 
  }
}

window.onload = sendWelcome;
document.getElementById("userInput").addEventListener("keydown", function (e) {
  if (e.key === "Enter") { e.preventDefault(); sendMessage(); }
});
</script>
</body>
</html>
