<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Retirex ‚Äì Asesor Inteligente de Retiro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-68HDQMVBVX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-68HDQMVBVX');
  </script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --magenta:#a0005a;
      --blue:#004b9a;
      --bg:#e5e5e5;
      --chat-bg:#f2f2f7;
      --bubble-user:#d40077;
      --bubble-ai:#ffffff;
      --radius:16px;
    }
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
    }
    .chat-container{width:100%;max-width:480px;height:100vh;background:var(--chat-bg);display:flex;flex-direction:column;padding-bottom:80px}
    .header{background:linear-gradient(135deg,var(--magenta),var(--blue));padding:14px;color:#fff;display:flex;gap:12px;font-weight:600;box-shadow: 0 2px 5px rgba(0,0,0,0.1)}
    .avatar{width:38px;height:38px;background:#fff;color:var(--magenta);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700}
    .messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:14px}
    .msg{max-width:85%;padding:12px 16px;border-radius:var(--radius);font-size:14px;line-height:1.45;animation: fadeIn 0.3s ease;word-wrap: break-word;}
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .ai{background:#fff;align-self:flex-start;border:1px solid rgba(0,0,0,.06);box-shadow:0 3px 10px rgba(0,0,0,.08)}
    .user{background:var(--bubble-user);color:#fff;align-self:flex-end}
    
    /* Inicio Visual con Tarjetas */
    .visual-options { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; width: 100%; }
    .card-option { background: #fff; border: 1px solid #e0e0e0; border-radius: 16px; padding: 16px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
    .card-option:hover { border-color: var(--magenta); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .card-option span { font-size: 24px; display: block; margin-bottom: 8px; }
    .card-option strong { display: block; color: var(--blue); font-size: 15px; margin-bottom: 4px; }
    .card-option p { margin: 0; font-size: 12px; color: #666; line-height: 1.3; }

    .input-area{position:fixed;bottom:0;width:100%;max-width:480px;background:#fff;padding:12px;display:flex;gap:10px;border-top:1px solid #ccc;box-sizing: border-box;}
    .input-area input{flex:1;padding:12px;border-radius:var(--radius);border:1px solid #ddd;outline:none;font-size:14px}
    .input-area button{background:var(--magenta);color:#fff;border:none;border-radius:var(--radius);padding:0 20px;font-weight:600;cursor:pointer}
    
    .option-button{width:100%;padding:12px;background:#fff;border-radius:12px;border:1px solid #dcdcdc;margin-top:8px;text-align:left;font-weight:600;cursor:pointer}
    .info-block{display:none;background:#f8f9fa;border:1px solid #e5e5e5;border-radius:12px;padding:12px;font-size:13px;margin-top:5px}
    .analysis-card { background: #fff; border-left: 5px solid var(--magenta); padding: 15px; border-radius: 12px; margin: 10px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .chart-wrapper{background:#fff;padding:14px;border-radius:16px;border:1px solid #e5e5e5;margin-top: 10px;}
    .cta-whatsapp{margin-top:18px;padding:16px;background:#fff;border-radius:14px;border:1px solid #e3e3e3;text-align: center;}
    .whatsapp-btn{background:#25D366;color:#fff;padding:12px 20px;border-radius:10px;font-weight:600;text-decoration:none;display:inline-block}
    .privacidad{font-size:11px;color:#6b6b6b;margin-top:8px}
  </style>
</head>

<body>
<div class="chat-container">
  <div class="header">
    <div class="avatar">R</div>
    Retirex ‚Äì Asesor Inteligente
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-area">
    <input id="userInput" placeholder="Escrib√≠ tu consulta..." autocomplete="off" />
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
let flow={step:0};

/* ================= TRACKING GA4 ================= */
function trackStep(name, val = null) {
  console.log(`[TRACKING]: ${name} | ${val}`);
  gtag('event', name, { 'event_category': 'Simulador_Retirex', 'value': val });
}

function addMessage(text, who="ai"){
  const d=document.createElement("div");
  d.className="msg "+who;
  d.innerHTML=text;
  document.getElementById("messages").appendChild(d);
  d.scrollIntoView({behavior:"smooth"});
}

function toggleBlock(id){
  const e=document.getElementById(id);
  if(e) e.style.display=e.style.display==="block"?"none":"block";
}

/* ================= ANALISIS DIN√ÅMICO (IA LOCAL) ================= */
function generateAnalysis(edad, retiro, aporte) {
  const a√±osAhorro = retiro - edad;
  if (a√±osAhorro >= 25) {
    return `<strong>An√°lisis Retirex: El poder del tiempo</strong><br>Ten√©s una ventaja estrat√©gica: <strong>${a√±osAhorro} a√±os</strong> de capitalizaci√≥n. A este ritmo, el inter√©s compuesto har√° el mayor esfuerzo por vos. Es un plan s√≥lido y de alta eficiencia.`;
  }
  if (a√±osAhorro < 20 && aporte >= 80000) {
    return `<strong>An√°lisis Retirex: Intensidad de capital</strong><br>Tu capacidad de aporte actual compensa el factor tiempo. Est√°s construyendo un blindaje financiero r√°pido y robusto para tu etapa de retiro.`;
  }
  if (a√±osAhorro < 15) {
    return `<strong>An√°lisis Retirex: Optimizaci√≥n estrat√©gica</strong><br>Con ${a√±osAhorro} a√±os restantes, el enfoque es la constancia. Tu plan es un gran primer paso; record√° que siempre podr√°s realizar aportes extraordinarios para potenciar el capital final.`;
  }
  return `<strong>An√°lisis Retirex: Plan Equilibrado</strong><br>Tu simulaci√≥n muestra una relaci√≥n saludable entre edad y esfuerzo de ahorro. Mantener este aporte mensual es lo que garantizar√° tu seguridad futura.`;
}

/* ================= BIENVENIDA VISUAL ================= */
function sendWelcome(){
  addMessage(`Hola üëã soy <strong>Retirex</strong>, tu asesor digital de Prevenci√≥n Retiro.<br><br>¬øEn qu√© etapa de tu futuro te gustar√≠a enfocarte hoy?`);
  addMessage(`
    <div class="visual-options">
      <div class="card-option" onclick="startSimulation('Independencia')">
        <span>üèùÔ∏è</span>
        <strong>Independencia Retiro</strong>
        <p>Proyect√° un futuro con libertad financiera.</p>
      </div>
      <div class="card-option" onclick="startSimulation('Protecci√≥n')">
        <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
        <strong>Protecci√≥n Familiar</strong>
        <p>Asegur√° el futuro de los que m√°s quer√©s.</p>
      </div>
      <div class="card-option" onclick="showFAQ()">
        <span>üí¨</span>
        <strong>Dudas frecuentes</strong>
        <p>Seguridad, rescates y garant√≠as del plan.</p>
      </div>
    </div>
  `);
}

function showFAQ(){
  addMessage(`<strong>Dudas frecuentes</strong><br><br>
    <button class="option-button" onclick="toggleBlock('faq1')">üß† ¬øQu√© es un plan de retiro?</button>
    <div id="faq1" class="info-block">Es un ahorro de largo plazo regulado por la SSN. Aport√°s, capitaliz√°s y al retirarte ten√©s un capital complementario. Pod√©s pausar o subir aportes.</div>
    <button class="option-button" onclick="toggleBlock('faq2')">üõ°Ô∏è ¬øQu√© tan seguro es?</button>
    <div id="faq2" class="info-block">Cuenta con respaldo del Grupo Sancor Seguros y rendimiento t√©cnico garantizado del 4% anual en pesos por contrato.</div>
  `);
}

function startSimulation(meta){
  flow={step:1, meta: meta};
  trackStep('simulacion_inicio', meta);
  addMessage(`Excelente elecci√≥n: <strong>${meta}</strong>. Vamos a calcularlo.<br><br>¬øCu√°l es tu sexo? (M/F)`);
}

async function sendMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;
  addMessage(text, "user");
  input.value = "";
  if (flow.step > 0) { handleFlow(text); return; }
  addMessage("Dame un segundo...", "ai");
  try {
    const r = await fetch("https://retirex.onrender.com/ia", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ messages: [{ role: "system", content: "Asesor Retirex" }, { role: "user", content: text }] })
    });
    const data = await r.json();
    addMessage(data?.reply || "Podemos iniciar una simulaci√≥n si quer√©s üòä");
  } catch (e) { addMessage("Por ahora podemos seguir con la simulaci√≥n."); }
}

function handleFlow(msg){
  if (flow.step === 1) {
    const s = msg.trim().toUpperCase();
    if (s !== "M" && s !== "F") { addMessage("Ingres√° **M** o **F**"); return; }
    flow.sexo = s; flow.step = 2;
    trackStep('paso_sexo', s);
    addMessage("üëç ¬øCu√°l es tu edad actual?");
    return;
  }
  if (flow.step === 2) {
    const e = Number(msg);
    if (isNaN(e) || e < 18 || e > 70) { addMessage("Ingres√° una edad entre 18 y 70"); return; }
    flow.edad = e; flow.step = 3;
    trackStep('paso_edad', e);
    addMessage("¬øA qu√© edad te gustar√≠a retirarte?");
    return;
  }
  if (flow.step === 3) {
    const r = Number(msg);
    if (isNaN(r) || r < flow.edad + 5 || r > 85) { addMessage(`Ingres√° una edad superior a ${flow.edad+5}`); return; }
    flow.retiro = r; flow.step = 4;
    trackStep('paso_retiro', r);
    addMessage("Perfecto. ¬øCu√°nto quer√©s aportar por mes? (M√≠nimo $30.000)");
    return;
  }
  if (flow.step === 4) {
    const a = Number(msg);
    if (isNaN(a) || a < 30000) { addMessage("El monto m√≠nimo de aporte es $30.000."); return; }
    flow.aporte = a; flow.step = 0;
    trackStep('paso_aporte', a);
    runSimulation();
  }
}

/* ================= SIMULACI√ìN CON ENTREGA PROGRESIVA ================= */
async function runSimulation() {
  const { sexo, edad, retiro, aporte } = flow;
  
  // ETAPA 1: Feedback inmediato (0s)
  addMessage("Calculando tu simulaci√≥n... ‚è≥");

  // ETAPA 2: An√°lisis Retirex (1.5s)
  setTimeout(() => {
    const analysisHTML = generateAnalysis(edad, retiro, aporte);
    addMessage(`<div class="analysis-card">${analysisHTML}</div>`);
  }, 1500);

  try {
    const r = await fetch("https://retirex.onrender.com/cotizar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sexo, edad_actual: edad, edad_retiro: retiro, aporte_mensual: aporte })
    });
    const data = await r.json();
    const oficial = data.oficial.capital;
    const realista = data.realista.capital;

    // ETAPA 3: Resultados Num√©ricos (4s)
    setTimeout(() => {
      addMessage(`
        <strong>Resultados listos üéâ</strong><br><br>
        <strong>Escenario oficial:</strong><br>$${oficial.toLocaleString("es-AR")}<br><br>
        <strong>Escenario realista:</strong><br>$${realista.toLocaleString("es-AR")}
      `);
      gtag('event', 'cotizacion_completada', { event_category: 'Retirex', event_label: 'Simulaci√≥n finalizada' });
    }, 4000);

    // ETAPA 4: Explicaci√≥n de la diferencia (7s) - TEXTO ORIGINAL
    setTimeout(() => {
      addMessage(`
        üîé Por qu√© la diferencia es tan grande<br><br>
        Ambos escenarios usan el mismo per√≠odo de tiempo y el mismo esfuerzo de ahorro.<br><br>
        La diferencia no est√° en cu√°nto tiempo pasa, sino en c√≥mo ese tiempo amplifica distintos supuestos de crecimiento a lo largo de los a√±os.<br><br>
        Al comienzo, la brecha es peque√±a. Con el paso del tiempo, esa diferencia se va acumulando y se hace m√°s visible, especialmente en los tramos finales del plan.<br><br>
        üëâ No es una elecci√≥n entre uno u otro. Es una forma de entender c√≥mo el largo plazo potencia los resultados.
      `);
    }, 7000);

    // ETAPA 5: Gr√°fico y Gu√≠a Detallada (10s) - TEXTO ORIGINAL
    setTimeout(() => {
      const chartId = "chart" + Date.now();
      addMessage(`<div class="chart-wrapper"><strong>Comparaci√≥n gr√°fica</strong><br><br><canvas id="${chartId}" height="160"></canvas></div>`);
      new Chart(document.getElementById(chartId), {
        type: "bar",
        data: { labels: ["Oficial", "Realista"], datasets: [{ data: [oficial, realista], backgroundColor: ["#a0005a", "#004b9a"], borderRadius: 10 }] },
        options: { plugins: { legend: { display: false } } }
      });

      addMessage(`<div style="font-size:12px;color:#666;margin-top:10px;"><strong>Importante:</strong> Simulaci√≥n orientativa. No constituye garant√≠a de rendimiento futuro.</div>`);

      addMessage(`
        <strong>Antes de seguir, una breve gu√≠a üëá</strong>
        <button class="option-button" onclick="toggleBlock('post1')">üß† C√≥mo leer estos resultados</button>
        <div id="post1" class="info-block">
          Esta simulaci√≥n muestra <strong>dos escenarios distintos</strong> porque un ahorro de largo plazo no se puede analizar con una sola cifra.<br><br>
          üîπ <strong>Escenario Oficial:</strong> Es una simulaci√≥n estimada por la compa√±√≠a, construida bajo criterios conservadores. No es un piso, ni una promesa, ni un m√≠nimo garantizado.<br><br>
          üîπ <strong>Escenario Realista:</strong> Refleja un crecimiento m√°s alineado con la l√≥gica del largo plazo en Argentina, cercano a la din√°mica hist√≥rica de los fondos en pesos.
        </div>
        <button class="option-button" onclick="toggleBlock('post2')">üõ°Ô∏è Qu√© tan seguro es este plan</button>
        <div id="post2" class="info-block">
          Producto de <strong>Prevenci√≥n Retiro (Grupo Sancor Seguros)</strong>. Regulado por la SSN. Capitalizaci√≥n individual: tu ahorro se registra a tu nombre y no se mezcla. Cuenta con un <strong>rendimiento t√©cnico garantizado del 4% anual en pesos</strong>.
        </div>
        <button class="option-button" onclick="toggleBlock('post3')">üîÑ Qu√© pasa si mi situaci√≥n cambia</button>
        <div id="post3" class="info-block">
          Este plan no es r√≠gido. Pod√©s subir o bajar el aporte, pausarlo si lo necesit√°s o hacer aportes extraordinarios. Se adapta a tu realidad.
        </div>
      `);

      // ETAPA 6: WhatsApp final (12s)
      const wsp = encodeURIComponent(`Hola, quiero avanzar con mi plan. Datos: ${edad} a√±os, aporte $${aporte}. Escenario realista: $${realista.toLocaleString("es-AR")}`);
      addMessage(`
        <div class="cta-whatsapp">
          <a class="whatsapp-btn" href="https://wa.me/5492804866612?text=${wsp}" target="_blank">üì≤ Hablar con un asesor</a>
          <p class="privacidad">Sin spam. Solo asesoramiento real.</p>
        </div>
      `);
    }, 10000);

  } catch (e) { addMessage("Error de conexi√≥n. Por favor reintent√°."); }
}

window.onload = sendWelcome;
document.getElementById("userInput").addEventListener("keydown", function (e) {
  if (e.key === "Enter") { e.preventDefault(); sendMessage(); }
});
</script>
</body>
</html>
