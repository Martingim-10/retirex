<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Retirex ‚Äì Asesor Inteligente de Retiro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <script async src="https://www.googletagmanager.com/gtag/js?id=G-68HDQMVBVX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-68HDQMVBVX');
  </script>

  <style>
    :root {
      --magenta:#a0005a;
      --blue:#004b9a;
      --bg:#e5e5e5;
      --chat-bg:#f2f2f7;
      --bubble-user:#d40077;
      --bubble-ai:#ffffff;
      --radius:16px;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      -webkit-font-smoothing: antialiased;
    }

    .chat-container{
      width:100%;
      max-width:480px;
      height:100vh;
      background:var(--chat-bg);
      display:flex;
      flex-direction:column;
      padding-bottom:80px
    }

    .header{
      background:linear-gradient(135deg,var(--magenta),var(--blue));
      padding:14px;
      color:#fff;
      display:flex;
      gap:12px;
      font-weight:600;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1)
    }

    .avatar{
      width:38px;
      height:38px;
      background:#fff;
      color:var(--magenta);
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700
    }

    .messages{
      flex:1;
      overflow-y:auto;
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:14px
    }

    .msg{
      max-width:85%;
      padding:12px 16px;
      border-radius:var(--radius);
      font-size:14px;
      line-height:1.45;
      animation: fadeIn 0.3s ease;
      word-wrap: break-word;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ai{
      background:#fff;
      align-self:flex-start;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 3px 10px rgba(0,0,0,.08)
    }

    .user{
      background:var(--bubble-user);
      color:#fff;
      align-self:flex-end
    }

    .visual-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
      width: 100%;
    }

    .card-option {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    .card-option:hover {
      border-color: var(--magenta);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .card-option span {
      font-size: 24px;
      display: block;
      margin-bottom: 8px;
    }

    .card-option strong {
      display: block;
      color: var(--blue);
      font-size: 15px;
      margin-bottom: 4px;
    }

    .card-option p {
      margin: 0;
      font-size: 12px;
      color: #666;
      line-height: 1.3;
    }

    .card-option.primary {
      background: linear-gradient(135deg, #a0005a 0%, #7a0044 100%);
      border: none;
      color: #fff;
      box-shadow: 0 10px 26px rgba(160, 0, 90, 0.45);
      transform: scale(1.06);
      position: relative;
      overflow: hidden;
    }

    .card-option.primary strong,
    .card-option.primary p {
      color: #fff;
    }

    .card-option.primary span {
      font-size: 30px;
    }

    .card-option.primary::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 16px;
      box-shadow: 0 0 0 0 rgba(160, 0, 90, 0.6);
      animation: pulse 2.5s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(160, 0, 90, 0.6); }
      70% { box-shadow: 0 0 0 14px rgba(160, 0, 90, 0); }
      100% { box-shadow: 0 0 0 0 rgba(160, 0, 90, 0); }
    }

    .input-area{
      position:fixed;
      bottom:0;
      width:100%;
      max-width:480px;
      background:#fff;
      padding:12px;
      display:flex;
      gap:10px;
      border-top:1px solid #ccc;
      box-sizing: border-box;
    }

    .input-area input{
      flex:1;
      padding:12px;
      border-radius:var(--radius);
      border:1px solid #ddd;
      outline:none;
      font-size:14px
    }

    .input-area button{
      background:var(--magenta);
      color:#fff;
      border:none;
      border-radius:var(--radius);
      padding:0 20px;
      font-weight:600;
      cursor:pointer
    }

    .option-button{
      width:100%;
      padding:14px;
      background:#fff;
      border-radius:14px;
      border:1px solid #dcdcdc;
      margin-top:10px;
      text-align:left;
      font-weight:600;
      font-size:15px;
      cursor:pointer
    }

    .info-block{
      display:none;
      background:#f8f9fa;
      border:1px solid #e5e5e5;
      border-radius:14px;
      padding:16px;
      font-size:15px;
      line-height:1.6;
      margin-top:8px;
    }

    .analysis-card {
      background: #fff;
      border-left: 5px solid var(--magenta);
      padding: 15px;
      border-radius: 12px;
      margin: 10px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .cta-whatsapp{
      margin-top:18px;
      padding:16px;
      background:#fff;
      border-radius:14px;
      border:1px solid #e3e3e3;
      text-align: center;
    }

    .whatsapp-btn{
      background:#25D366;
      color:#fff;
      padding:12px 20px;
      border-radius:10px;
      font-weight:600;
      text-decoration:none;
      display:inline-block
    }

    .privacidad{
      font-size:11px;
      color:#6b6b6b;
      margin-top:8px
    }
  </style>
</head>

<body>

<div class="chat-container">
  <div class="header">
    <div class="avatar">R</div>
    Retirex ‚Äì Asesor Inteligente
  </div>

  <div class="messages" id="messages"></div>

  <div class="input-area">
    <input id="userInput" placeholder="Escrib√≠ tu consulta..." autocomplete="off" />
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
let flow = { step: 0 };

/* ================= TRACKING GA4 ================= */
function trackStep(name, val = null) {
  try {
    console.log(`[TRACKING]: ${name} | ${val}`);
    gtag('event', name, { event_category: 'Simulador_Retirex', value: val });
  } catch(e) {}
}

/* ================= UTIL ================= */
function addMessage(text, who="ai"){
  const d = document.createElement("div");
  d.className = "msg " + who;
  d.innerHTML = text;
  document.getElementById("messages").appendChild(d);
  d.scrollIntoView({ behavior:"smooth" });
}

function toggleBlock(id){
  const e = document.getElementById(id);
  if (e) e.style.display = (e.style.display === "block") ? "none" : "block";
}

/* ================= ANALISIS DIN√ÅMICO (LOCAL) ================= */
function generateAnalysis(edad, retiro, aporte) {
  const a√±osAhorro = retiro - edad;

  if (a√±osAhorro >= 25) {
    return `<strong>An√°lisis Retirex: El poder del tiempo</strong><br><br><br>
      Ten√©s una ventaja estrat√©gica: <strong>${a√±osAhorro} a√±os</strong> de capitalizaci√≥n.<br><br>
      A este ritmo, el inter√©s compuesto har√° el mayor esfuerzo por vos.`;
  }

  if (a√±osAhorro < 20 && aporte >= 80000) {
    return `<strong>An√°lisis Retirex: Intensidad de capital</strong><br><br><br>
      Tu capacidad de aporte compensa el factor tiempo. Est√°s construyendo un blindaje fuerte.`;
  }

  if (a√±osAhorro < 15) {
    return `<strong>An√°lisis Retirex: Optimizaci√≥n estrat√©gica</strong><br><br><br>
      Con <strong>${a√±osAhorro} a√±os</strong>, el foco es constancia. Pod√©s potenciar con aportes extraordinarios cuando puedas.`;
  }

  return `<strong>An√°lisis Retirex: Plan equilibrado</strong><br><br><br>
    Tu simulaci√≥n muestra una relaci√≥n saludable entre edad y esfuerzo de ahorro.`;
}

/* ================= IA FALLBACK (CONTROLADO) ================= */
async function callAI(userMessage) {
  const systemPrompt = `
Sos Retirex, un asesor digital especializado en planes de retiro en Argentina, en particular en planes de Prevenci√≥n Retiro.

Reglas estrictas:
- Respond√© solo preguntas relacionadas con planes de retiro, ahorro previsional y simulaciones.
- No hables de inversiones generales, crypto, pol√≠tica ni temas ajenos.
- No prometas rendimientos ni inventes n√∫meros.
- Lenguaje claro, humano y prudente.
- Si no corresponde, redirig√≠ con educaci√≥n.
- Cerr√° invitando a simular o continuar el an√°lisis.
`;

  try {
    const response = await fetch("https://retirex.onrender.com/ia", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        messages: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userMessage }
        ]
      })
    });

    const data = await response.json();
    return data?.reply || "Si quer√©s, puedo ayudarte con una simulaci√≥n üòä";
  } catch (error) {
    return "Ahora mismo no puedo responder esa consulta. Si quer√©s, seguimos con una simulaci√≥n.";
  }
}

/* ================= BIENVENIDA MODIFICADA ================= */
/* ================= BIENVENIDA (ARRANQUE DIRECTO) ================= */

function sendWelcome() {

  addMessage(`
    Hola üëã soy <strong>Retirex</strong>, tu asesor digital de retiro.<br><br>

    Para que tengas una referencia r√°pida üëá<br><br>

    Una persona de <strong>40 a√±os</strong>, aportando <strong>$40.000 por mes</strong> durante 20 a√±os,
    podr√≠a acumular alrededor de:<br><br>

    <strong style="font-size:22px;color:#004b9a;">
      $300.000.000
    </strong><br><br>

    Es un <strong>ejemplo orientativo</strong>, pero muestra el poder del largo plazo.<br><br>

    üëâ Si quer√©s ver <strong>tu caso</strong>, decime:
    <br><br>
    <strong>¬øqu√© edad ten√©s hoy?</strong>
  `);

  // arrancamos el flujo directamente en edad
  flow = { step: 2 };

  trackStep('chat_inicio_directo', 1);
}


/* ================= FAQ ================= */
function showFAQ() {
  addMessage(`
    <strong>Dudas frecuentes</strong><br><br><br><br>

    <button class="option-button" onclick="toggleBlock('faq1')">
      üß† ¬øQu√© es un plan de retiro y para qu√© sirve?
    </button>
    <div id="faq1" class="info-block">
      Un plan de retiro es un ahorro de largo plazo regulado por la
      <strong>Superintendencia de Seguros de la Naci√≥n</strong>.<br>
      Su objetivo es complementar tu jubilaci√≥n con un capital propio.<br><br><br>
      Funciona as√≠: aport√°s todos los meses, el dinero se capitaliza
      y al retirarte cont√°s con un fondo acumulado.
    </div>

    <button class="option-button" onclick="toggleBlock('faq2')">
      üõ°Ô∏è ¬øQu√© tan seguro es este plan?
    </button>
    <div id="faq2" class="info-block">
      Producto de <strong>Prevenci√≥n Retiro</strong> (Grupo Sancor Seguros),<br>
      regulado por la SSN y con capitalizaci√≥n individual.<br>
      Adem√°s, cuenta con <strong>rendimiento t√©cnico garantizado</strong><br>
      seg√∫n condiciones de p√≥liza.
    </div>

    <button class="option-button" onclick="toggleBlock('faq3')">
      üîÑ ¬øQu√© pasa si mi situaci√≥n cambia?
    </button>
    <div id="faq3" class="info-block">
      Pod√©s ajustar el aporte, pausarlo o reforzarlo con aportes extraordinarios.<br>
      El plan se adapta a tu vida.
    </div>

    <button class="option-button" onclick="toggleBlock('faq4')">
      üí∞ ¬øSe puede retirar el dinero antes?
    </button>
    <div id="faq4" class="info-block">
      Puede haber opciones de rescate anticipado seg√∫n etapa del plan<br>
      y condiciones de p√≥liza. Conviene analizar cada caso.
    </div>

    <br><br><br>
    <button class="option-button" onclick="sendWelcome()">
      üßÆ Ver mi proyecci√≥n personal
    </button>
  `);

  trackStep('menu_click', 'faq');
}

/* ================= EJEMPLO REALISTA ================= */
function showEjemplo40() {
  addMessage(`
    Veamos un ejemplo <strong>orientativo</strong> para tener una referencia concreta üëá<br><br><br><br>
    Supongamos una persona de <strong>40 a√±os</strong> que comienza hoy un plan de retiro.<br><br><br><br>
    Aportando <strong>$40.000 por mes</strong> durante <strong>20 a√±os</strong>,<br>
    el capital acumulado estimado al momento del retiro podr√≠a rondar:<br><br><br><br>
    <strong style="font-size:22px;color:#004b9a;"><br>
      $312.821.017<br>
    </strong><br><br><br><br>
    Este n√∫mero surge de un <strong>escenario realista de largo plazo</strong>,<br>
    considerando constancia en los aportes y el efecto del tiempo.<br><br><br><br>
    üìå Es un <strong>ejemplo orientativo</strong>.<br>
    No constituye garant√≠a de resultado ni oferta comercial.
  `);

  trackStep('ejemplo_40_visto', 1);

  addMessage(`
    <div class="visual-options">
      <div class="card-option primary" onclick="sendWelcome()">
        <span>üßÆ</span>
        <strong>Ver mi proyecci√≥n personal</strong>
        <p>Basada en mi edad y aporte</p>
      </div>
      <div class="card-option" onclick="showFAQ()">
        <span>üí¨</span>
        <strong>Dudas frecuentes</strong>
      </div>
    </div>
  `);
}

/* ================= MENSAJER√çA ================= */
async function sendMessage() {
  const input = document.getElementById("userInput");
  const text = input.value.trim();
  if (!text) return;

  addMessage(text, "user");
  trackStep('mensaje_usuario', 1);
  input.value = "";

  if (flow.step > 0) {
    handleFlow(text);
    return;
  }

  addMessage("Dame un segundo...", "ai");
  const aiReply = await callAI(text);
  addMessage(aiReply);

  addMessage(`
    <button class="option-button" onclick="sendWelcome()">üßÆ Simular mi plan</button>
    <button class="option-button" onclick="showFAQ()">üí¨ Dudas frecuentes</button>
  `);
}

/* ================= FLUJO GUIADO (SIN PASO DE SEXO) ================= */
function handleFlow(msg){
  // El step 1 (sexo) se omite completamente para cumplir el Cambio 2
  if (flow.step === 2) {
    const e = Number(msg);
    if (isNaN(e) || e < 18 || e > 70) { 
        addMessage("Ingres√° una edad v√°lida entre **18 y 70** üòä"); 
        return; 
    }
    flow.edad = e;
    flow.step = 3;
    trackStep('paso_edad', e);
    addMessage("¬øA qu√© edad te gustar√≠a retirarte?");
    return;
  }

  if (flow.step === 3) {
    const r = Number(msg);
    const minRetiro = flow.edad + 5;
    if (isNaN(r) || r < minRetiro || r > 85) {
      addMessage(`Eleg√≠ una edad de retiro v√°lida üòä<br>üëâ M√≠nimo: ${minRetiro}<br>üëâ M√°ximo: 85`);
      return;
    }
    flow.retiro = r;
    flow.step = 4;
    trackStep('paso_retiro', r);
    addMessage("Perfecto. ¬øCu√°nto quer√©s aportar por mes? (M√≠nimo $40.000)");
    return;
  }

  if (flow.step === 4) {
    const texto = msg.toLowerCase().trim();
    const aceptaMinimo = ["ok", "okay", "dale", "si", "s√≠", "minimo", "m√≠nimo", "el minimo", "el m√≠nimo", "lo minimo", "lo m√≠nimo", "eso", "el minimo esta bien", "el m√≠nimo est√° bien"];

    if (aceptaMinimo.includes(texto)) {
      flow.aporte = 40000;
      flow.step = 0;
      trackStep('paso_aporte', 40000);
      addMessage("Perfecto üëç tomamos el aporte m√≠nimo de **$40.000**.");
      runSimulation();
      return;
    }

    const limpio = msg.replace(/[^0-9]/g, "");
    const a = Number(limpio);

    if (isNaN(a) || a < 40000) {
      addMessage("El monto m√≠nimo de aporte es **$40.000** üòä\nPod√©s escribir *m√≠nimo* si quer√©s usar ese valor.");
      return;
    }

    flow.aporte = a;
    flow.step = 0;
    trackStep('paso_aporte', a);
    runSimulation();
    return;
  }
}

/* ================= POST-COTIZACI√ìN (BLOQUES COMPLETOS) ================= */
function showPostInfoBlocks() {
  addMessage(`
    <br><br>
    <strong>Antes de seguir, una breve gu√≠a üëá</strong><br><br><br><br>
    <button class="option-button" onclick="toggleBlock('post1')">üß† C√≥mo leer estos resultados</button>
    <div id="post1" class="info-block">
        Esta simulaci√≥n muestra <strong>dos escenarios distintos</strong> porque un ahorro de largo plazo no se puede analizar con una sola cifra.<br><br><br><br>
        üîπ <strong>Escenario Oficial:</strong> Es una simulaci√≥n estimada por la compa√±√≠a, construida bajo criterios conservadores.<br><br><br><br>
        üîπ <strong>Escenario Realista:</strong> Refleja un crecimiento m√°s alineado con la l√≥gica del largo plazo en Argentina.
    </div>

    <button class="option-button" onclick="toggleBlock('post2')">üõ°Ô∏è Qu√© tan seguro es este plan</button>
    <div id="post2" class="info-block">
        Producto de <strong>Prevenci√≥n Retiro (Grupo Sancor Seguros)</strong>. Regulado por la SSN. Capitalizaci√≥n individual: tu ahorro se registra a tu nombre y cuenta con una <strong>tasa t√©cnica m√≠nima garantizada, establecida por normativa de la Superintendencia de Seguros de la Naci√≥n, utilizada como base de c√°lculo del plan.</strong>.
    </div>

    <button class="option-button" onclick="toggleBlock('post3')">üîÑ Qu√© pasa si mi situaci√≥n cambia</button>
    <div id="post3" class="info-block">
      Pod√©s ajustar el aporte, pausarlo o reforzarlo con aportes extraordinarios. El plan se adapta a tu vida.
    </div>
  `);
}

/* ================= SIMULACI√ìN ================= */
async function runSimulation() {
  const { sexo, edad, retiro, aporte } = flow;

  addMessage("Calculando tu simulaci√≥n... ‚è≥");

  const analysisHTML = generateAnalysis(edad, retiro, aporte);
  addMessage(`<div class="analysis-card">${analysisHTML}</div>`);

  try {
    const r = await fetch("https://retirex-api-v1-571092083944.us-east1.run.app/cotizar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        sexo,
        edad_actual: edad,
        edad_retiro: retiro,
        aporte_mensual: aporte
      })
    });

    const data = await r.json();

    const oficial = data.oficial.capital;
    const realista = data.realista.capital;

    addMessage(`
      <br>
      <strong>Resultado de tu simulaci√≥n</strong><br><br><br><br>
      <strong>Escenario oficial:</strong><br>
      $${oficial.toLocaleString("es-AR")}<br><br><br><br>
      <strong style="font-size:18px;color:#004b9a;"><br>
        Escenario realista:<br>
      </strong>
      <strong style="font-size:22px;color:#004b9a;"><br>
        $${realista.toLocaleString("es-AR")}<br>
      </strong>
    `);

    gtag('event', 'cotizacion_completada', {
      event_category: 'Retirex',
      event_label: 'Simulaci√≥n finalizada'
    });

    addMessage(`
      <br>
      <div style="font-size:12px;color:#666;margin-top:6px;">
        Simulaci√≥n orientativa. No constituye garant√≠a de rendimiento futuro.
      </div>
    `);

    showPostInfoBlocks();

    const wsp = encodeURIComponent(
      `Hola! Acabo de usar el cotizador de Retirex,vi mi proyecci√≥n realista y quiero saber c√≥mo alcanzarla.\nEdad: ${edad}\nAporte: $${aporte}\nEscenario realista: $${realista.toLocaleString("es-AR")}`
    );

    addMessage(`
      <br>
      <div class="cta-whatsapp">
        <a class="whatsapp-btn" href="https://wa.me/5492804866612?text=${wsp}" target="_blank">
          üì≤ Quiero saber c√≥mo alcanzar este objetivo
        </a>
        <p class="privacidad">Sin spam. Solo asesoramiento real.</p>
      </div>
    `);

  } catch (e) {
    addMessage("Hubo un problema al calcular la simulaci√≥n. Por favor, intent√° nuevamente.");
  }
}

/* ================= INIT ================= */
window.onload = sendWelcome;

document.getElementById("userInput").addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});
</script>

</body>
</html>
